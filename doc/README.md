# Как работает Campfire
Эта папка предназначена для тех, кто хочет
создать свой клиент, но не хочет париться с
пониманием чужого кода.

## Отправка запросов
Все сервисы держатся на `46.254.16.245`. Там
есть несколько главных TCP-портов:
- `4027` TLS-сертификат для главного сервера
- `4026` Главный сервер
- `4024` TLS-сертификат для сервера медиа
- `4023` Сервер медиа

К главным серверам (вкл. медиа) запросы идут
по TLS c сертификатом, который выдается на
соседнем порту. Рассматривать как получать
сертификат я не буду, потому что я не знаю
как нормально его использовать.

### Теперь точно отправка
Для начала надо подключится через TLS к порту
главного/медиа сервера. Сертификат игнорируем,
он самоподписанный. Потом необходимо отправить
32-битную длину запроса (big-endian), после неё
отправить сам запрос.

Получение ответа такое же, читаем 32-битную
длину ответа и сам ответ.

### Формат запроса
> В `_` комментарии, их не надо оставлять в
> запросе. :)

```json
{
    "_": "Это название запроса, совпадает с названием класса Request",
    "J_REQUEST_NAME": "RAccountsGet", 
    "_": "Время отправки запроса в наносекундах (игнорируется сервером)",
    "J_REQUEST_DATE": 1626604387812000000,
    "J_API_LOGIN_TOKEN": "[расскажу позже]",
    "J_API_ACCESS_TOKEN": "[расскажу позже]",
    "_": "Оставьте это поле пока пустым",
    "J_API_REFRESH_TOKEN": "",
    "_": "1.251 для главного сервера, 1 для медиа",
    "requestApiVersion": "1.251",
    "_": "Имя проекта (может ещё быть Campfire-Anime и др.)",
    "requestProjectKey": "Campfire",
    
    "_": "Остальные поля определяются запросом"
}
```

### Вход
Чтобы войти, необходимо отправить запрос
`RAccountsLogin` или `RAccountsLoginSimple`.
В запросе надо обязательно указать `J_API_LOGIN_TOKEN`.

Для входа через email, формат такой:
`Email - <email> - <пароль в MD5>`.

Любой запрос может также отправить в ответ
`J_API_ACCESS_TOKEN`, его надо сохранять и
отправлять в след. запросах.

> При создании нового аккаунта `RAccountsLogin`
> почему-то не отправляет в ответ `J_API_ACCESS_TOKEN`.
> Я ещё это не изучал, но буду рад если кто-то
> сделает это за меня.

### Поля запросов
В репозитории [CampfireApi](https://github.com/ZeonXX/CampfireApi)
есть все существующие запросы к главному серверу.
Метод `jsonSub` каждого `Request` занимается
кодированием и декодированием запроса в JSON.
Второй аргумент к `json.m` определяет название
в JSON-файле.

### Получение картинок
Чтобы скачать какой-либо ресурс по ID, надо
отправить запрос `RResourcesGet` (см.
[CampfireApiMedia](https://github.com/ZeonXX/CampfireApiMedia)).

Ответ приходит не в JSON, а просто как сама
картинка (32-битная длина остаётся).

### Отправка картинок/бинарных данных
Чтобы отправить какие-то не текстовые данные
надо в JSON-объекте добавить строку `dataOutput`,
которая является массивом (JSON-закодированным) с
длиной каждого из кусков данных. При этом 32-битная
длина остаётся только длиной текстовой части запроса.
Куски данных идут сразу после текстовой части.

Наглядный пример:
```
Бинарные данные: 32-битная длина
Текст: {
    "...": "...",
    "dataOutput": "[10, 20]"
}
Бинарные данные: 10 байт данных первого куска
Бинарные данные: 20 байт данных второго куска
```

### Примеры
- [Прокси на Rust](https://github.com/timas130/campweb/blob/main/proxy/src/main.rs#L83-L102)
- [Клиент для прокси на JS](https://github.com/timas130/campweb/blob/main/campweb/src/api/ApiContext.js#L40)
